import numpy as np
import matplotlib.pyplot as plt
from sklearn.metrics import confusion_matrix

# Make plots a bit bigger by default
plt.rcParams["figure.figsize"] = (6, 4)


# =============================================================================
# Generic helpers
# =============================================================================

def plot_confusion_matrix_from_labels(y_true, y_pred, title, labels=("Fail", "Pass")):
    """Draw a confusion matrix heatmap using matplotlib only."""
    y_true = np.array(y_true)
    y_pred = np.array(y_pred)

    mask = ~np.isnan(y_true) & ~np.isnan(y_pred)
    y_t = y_true[mask].astype(int)
    y_p = y_pred[mask].astype(int)
    if len(y_t) == 0:
        print(f"[{title}] Not enough data to plot confusion matrix.")
        return

    cm = confusion_matrix(y_t, y_p, labels=[0, 1])

    fig, ax = plt.subplots()
    im = ax.imshow(cm, interpolation="nearest")
    ax.set_title(title)
    fig.colorbar(im, ax=ax)

    # Tick labels
    ax.set_xticks([0, 1])
    ax.set_yticks([0, 1])
    ax.set_xticklabels(labels)
    ax.set_yticklabels(labels)
    ax.set_xlabel("Model prediction")
    ax.set_ylabel("Human label")

    # Annotate cells
    for i in range(cm.shape[0]):
        for j in range(cm.shape[1]):
            ax.text(j, i, cm[i, j], ha="center", va="center", color="w")

    plt.tight_layout()
    # plt.show()


def plot_bar(values, labels, title, ylabel=None):
    """Simple vertical bar plot."""
    x = np.arange(len(values))
    fig, ax = plt.subplots()
    ax.bar(x, values)
    ax.set_xticks(x)
    ax.set_xticklabels(labels, rotation=20)
    ax.set_title(title)
    if ylabel:
        ax.set_ylabel(ylabel)
    ax.grid(axis="y", linestyle="--", alpha=0.4)
    plt.tight_layout()
    # plt.show()


def plot_grouped_bar(groups, values_a, values_b, label_a, label_b, title, ylabel=None):
    """Side-by-side bar chart for two series over same groups."""
    x = np.arange(len(groups))
    width = 0.35

    fig, ax = plt.subplots()
    ax.bar(x - width/2, values_a, width, label=label_a)
    ax.bar(x + width/2, values_b, width, label=label_b)

    ax.set_xticks(x)
    ax.set_xticklabels(groups, rotation=20)
    ax.set_title(title)
    if ylabel:
        ax.set_ylabel(ylabel)
    ax.legend()
    ax.grid(axis="y", linestyle="--", alpha=0.4)
    plt.tight_layout()
    # plt.show()


# =============================================================================
# A) Vendor dataset plots
# =============================================================================

def plot_vendor_confusion_matrix(df_vendor):
    plot_confusion_matrix_from_labels(
        df_vendor["human_pass_vendor"].values,
        df_vendor["llm_pass_vendor"].values,
        title="Vendor – Machine vs Human (Pass/Fail)"
    )

def plot_vendor_error_bar(df_vendor):
    """Bar chart of error types (Agree / FP / FN) for vendor data."""
    if "error_type_vendor" not in df_vendor.columns:
        print("[Vendor error bar] 'error_type_vendor' not found; run classification first.")
        return

    counts = df_vendor["error_type_vendor"].value_counts()
    plot_bar(
        counts.values,
        counts.index.tolist(),
        title="Vendor – Error Type Counts",
        ylabel="Count"
    )

def plot_vendor_facet_means_by_human(df_vendor):
    """Grouped bars: machine facet means for human-pass vs human-fail rows."""
    facet_cols_vendor = [
        c for c in df_vendor.columns
        if c.endswith("_score_vendor") and any(f in c for f in ["relevance","comprehensiveness","consistency","objectivity"])
    ]
    if not facet_cols_vendor:
        print("[Vendor facets] No *_score_vendor columns found.")
        return

    human_col = "human_pass_vendor"
    groups = []
    means_pass = []
    means_fail = []

    for col in facet_cols_vendor:
        fp = df_vendor.loc[df_vendor[human_col] == 1, col].mean()
        ff = df_vendor.loc[df_vendor[human_col] == 0, col].mean()
        groups.append(col.replace("_score_vendor", "").replace("_", " ").title())
        means_pass.append(fp)
        means_fail.append(ff)

    plot_grouped_bar(
        groups,
        means_pass,
        means_fail,
        label_a="Human Pass rows",
        label_b="Human Fail rows",
        title="Vendor – Machine Facet Means by Human Label",
        ylabel="Facet score"
    )


# =============================================================================
# B) Your dataset plots
# =============================================================================

def plot_user_confusion_matrix(df_user):
    if "machine_pass_user" not in df_user.columns:
        print("[User confusion] 'machine_pass_user' not found.")
        return

    plot_confusion_matrix_from_labels(
        df_user["human_pass"].values,
        df_user["machine_pass_user"].values,
        title="Your Data – Machine vs Human (Weighted Pass/Fail)"
    )

def plot_user_error_bar(df_user):
    if "error_type_user" not in df_user.columns:
        print("[User error bar] 'error_type_user' not found; run error classification first.")
        return

    counts = df_user["error_type_user"].value_counts()
    plot_bar(
        counts.values,
        counts.index.tolist(),
        title="Your Data – Error Type Counts",
        ylabel="Count"
    )

def plot_user_facet_correlations(df_user):
    """
    Bar chart of facet correlations (machine facet vs human facet).
    Assumes columns:
      machine: relevance_score, comprehensiveness_score, consistency_score, objectivity_score
      human  : human_relevance, human_comprehensiveness, human_consistency, human_objectivity
    """
    facet_pairs = [
        ("relevance_score",          "human_relevance",          "Relevance"),
        ("comprehensiveness_score",  "human_comprehensiveness",  "Comprehensiveness"),
        ("consistency_score",        "human_consistency",        "Consistency"),
        ("objectivity_score",        "human_objectivity",        "Objectivity"),
    ]

    labels = []
    corrs = []
    for mcol, hcol, label in facet_pairs:
        if mcol in df_user.columns and hcol in df_user.columns:
            sub = df_user[[mcol, hcol]].dropna()
            if len(sub) > 1:
                r = sub[mcol].corr(sub[hcol])
                corrs.append(r)
                labels.append(label)

    if not labels:
        print("[User facet corr] No valid facet pairs found.")
        return

    plot_bar(
        corrs,
        labels,
        title="Your Data – Machine vs Human Facet Correlations",
        ylabel="Correlation"
    )

def plot_user_facet_means(df_user):
    """Grouped bars: machine vs human facet means on your dataset."""
    facet_pairs = [
        ("relevance_score",          "human_relevance",          "Relevance"),
        ("comprehensiveness_score",  "human_comprehensiveness",  "Comprehensiveness"),
        ("consistency_score",        "human_consistency",        "Consistency"),
        ("objectivity_score",        "human_objectivity",        "Objectivity"),
    ]

    labels = []
    mach_means = []
    hum_means  = []

    for mcol, hcol, label in facet_pairs:
        if mcol in df_user.columns and hcol in df_user.columns:
            m_mean = df_user[mcol].mean()
            h_mean = df_user[hcol].mean()
            mach_means.append(m_mean)
            hum_means.append(h_mean)
            labels.append(label)

    if not labels:
        print("[User facet means] No valid facet pairs found.")
        return

    plot_grouped_bar(
        labels,
        hum_means,
        mach_means,
        label_a="Human",
        label_b="Machine",
        title="Your Data – Facet Mean Scores (Human vs Machine)",
        ylabel="Average score"
    )


# =============================================================================
# C) Benchmark plots (if model_summary from benchmark code exists)
# =============================================================================

def plot_benchmark_metric_bars(model_summary, metric="accuracy"):
    """
    Bar chart of a chosen metric across models.
    Expects model_summary as a DataFrame with index=model_name and columns including metric.
    """
    if model_summary is None or metric not in model_summary.columns:
        print(f"[Benchmark metric] '{metric}' not in model_summary.")
        return

    labels = model_summary.index.tolist()
    vals = model_summary[metric].values
    plot_bar(
        vals,
        labels,
        title=f"Benchmark – {metric.capitalize()} by Model",
        ylabel=metric.capitalize()
    )

def plot_benchmark_facet_corr(model_summary, facet="relevance"):
    """
    Bar chart of facet correlations per model.
    Expects columns like 'relevance_corr', 'comprehensiveness_corr', etc.
    """
    col = f"{facet}_corr"
    if model_summary is None or col not in model_summary.columns:
        print(f"[Benchmark facet corr] '{col}' not in model_summary.")
        return

    labels = model_summary.index.tolist()
    vals = model_summary[col].values
    plot_bar(
        vals,
        labels,
        title=f"Benchmark – {facet.capitalize()} Correlation by Model",
        ylabel="Correlation"
    )


# =============================================================================
# HOW TO USE (examples)
# =============================================================================
# After running your analysis code and this plotting code, you can do things like:
#
#   plot_vendor_confusion_matrix(df_vendor)
#   plot_vendor_error_bar(df_vendor)
#   plot_vendor_facet_means_by_human(df_vendor)
#
#   plot_user_confusion_matrix(df_user)
#   plot_user_error_bar(df_user)
#   plot_user_facet_correlations(df_user)
#   plot_user_facet_means(df_user)
#
#   # If you ran the benchmark and have model_summary:
#   plot_benchmark_metric_bars(model_summary, metric="accuracy")
#   plot_benchmark_metric_bars(model_summary, metric="f1")
#   plot_benchmark_facet_corr(model_summary, facet="relevance")
#   plot_benchmark_facet_corr(model_summary, facet="comprehensiveness")
#
# Uncomment plt.show() inside functions if you prefer them to auto-display.
# Or call plt.show() yourself after a batch of plots in notebooks / scripts.
# =============================================================================
